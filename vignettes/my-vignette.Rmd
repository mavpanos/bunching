---
title: "Introduction to Bunching with the `bunching` package"
author: Panos Mavrokonstantis
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
header-includes: 
  - \usepackage{amssymb}
  - \usepackage{mathds}
vignette: >
  %\VignetteIndexEntry{Bunching}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(markdown.HTML.stylesheet = "default.css")

```

```{r setup, include = F}
library(bunching)
```


This document introduces you to the `bunching` package's basic toolkit, and shows examples of how it can be applied to data that feature bunching. 


# Introduction

The `bunching` package implements the bunching estimator, as developed (in different flavors and applications) by Saez (2010), Chetty et al. (2011) and Kleven et al. (2013). The estimator is increasingly being implemented within the fields of labor and public economics, but can be applied to any setting where a constrained optimization problem involves a discontinuity in the constraint, which can be related to a discontinuity in the observed density of the decision variable. The aim of the estimator is to credibly estimate the resulting bunching (i.e. excess mass), over and above what would have been observed in the absence of the discontinuity in the constraint. 

This is a challenge of causal inference, since we would like to attribute the excess mass to a particular discontinuity in a constraint, but cannot typically observe the counterfactual density in the absence of that constraint. The novelty of this estimator is that it provides a method to estimate this counterfactual density in such settings by combining reduced-form methods and theoretically-founded micro-economic optimisation models. Having estimated the excess mass, we can use them to estimate recover economic parameters of interest, such as elasticities or other structural parameters.

I will explain the intuition using the original setting for which bunching was developed: analyzing behavioral responses to income taxes. The following analysis closely follows Mavrokonstantis (2019). For a longer review, see Kleven (2016). Two main types of disconinuities are considered, and supported by the package: kinks, i.e. changes in the slopes of constraints, and notches, i.e. changes in the levels of choice sets.

# Theoretical foundations: Why would we expect to see bunching?

## Theoretical foundations: Kinks
Let's consider the setting of income taxes. In most countries, income taxes follow what is called a progressive tax schedule, which features several brackets, with the marginal tax rate increasing as incomes enter higher brackets. This creates "kinks" at the thresholds where brackets change, because only income falling in that bracket is subject to its marginal tax rate; the other case is a notch, where all income is subject to that bracket's tax rate. 

From a taxpayer's optimisation perspective, we want to understand how the presence of a kink affects his incentives and behavioral responses to tax reforms. We can do this by first considering the case where no kinks are in place, and  analyse what changes when a kink is introduced. 

We model this  using the following setup. We have a population of workers, where each has preferences over consumption $c$ and taxable income $z$, and differs by ability $n$. Utility $u(c,z;n)$ is increasing and concave in consumption ($u_c >0$, $u_{cc} < 0$), and decreasing and convex in earnings ($u_z <0$, $u_{zz} >0$), capturing the idea that the effort associated with labor supply is costly. Tax on income $z$ is denoted by the function $T(z)$, which will be non-linear in the case of kinks and notches. We can linearise this by using  "virtual" income $R=z-T(z)-[1-T'(z)]z$, and defining the optimisation problem as simply:


$$\max_{c,z} \quad U(c,z;n)$$
$$s.t. \quad c = (1-\tau)z + R $$

\medskip{}

The first-order condition $(1-\tau)u_c + u_z = 0$ leads to an optimal level of earnings given by $z = z((1-t);n)$, where the only source of heterogeneity is ability $n$. If this ability distribution is smooth and the tax schedule is linear ($T(z) = \tau_0$ $\forall z$), then our model predicts that the distribution of earnings will also be smooth, with cdf $H_0(z)$ and pdf $h_0(z)$. This is depicted in the following figures. 

```{r, echo=FALSE,out.width="45%",  out.height="20%",fig.cap="Linear Tax Schedules and Densities",fig.show='hold',fig.align='center'}
knitr::include_graphics(c("jpegs/lineartax_budget.jpg","jpegs/lineartax_density.jpg"))
```

The figure on the left depicts typical indifference curves and a linear budget constraint. It shows that under a linear tax schedule, workers will optimise by finding the tangency points between their indifference curves and the budget accordingly. Importantly, they will distribute themsleves  along this constraint smoothly, according to their heterogeneous ability Those with higher ability will optimise at higher combinations of consumption and earnings. This is because the opportunity cost of leisure, given by ability $n$, is higher. The figure on the right shows the associated density, which as a result is also smooth.



```{r, echo=FALSE,out.width="45%",  out.height="20%",fig.cap="Kinked Tax Schedules and Densities",fig.show='hold',fig.align='center'}
knitr::include_graphics(c("jpegs/kink_budget.jpg", "jpegs/kink_density.jpg"))
```


Next consider the creation of a second bracket, increasing the marginal tax rate from $t_0$ to $t_1$ for earnings above $z^*$. This nonlinear schedule features a convex kink, shown above on the left. Recall that optimal earnings are given by $z = z((1-t);n)$, which has now changed for those above $z^*$. These individuals will now respond to this tax reform by decreasing their earnings. The figure on the right shows the effect of the kink at $z^*$ on the distribution of earnings. Individuals in a range $z\in(z^*,z^*+\Delta z^*]$ optimize by moving to the kink level $z^*$, which creates the bunching mass. Not everyone above $z^*$ will find it optimal to reduce earnings to the kink; the bunching range can be identified by a marginal buncher, i.e. the individual with the highest earnings under the linear tax schedule who chooses to bunch under the nonlinear schedule. This is the individual tangent both at $z^* + \Delta z^*$ under the linear schedule, and the upper part of the nonlinear budget set at $z^*$. 


Hence, bunching will be given by  

$$B = \int_{z^*}^{z^*+\Delta z^*} h_0(z)dz$$

The question is how to estimate credibly. See vignette X for details on how this isdone.

### From Bunching at Kinks to Elasticities

The key point of estimating the bunching mass is to recover an economic parameter of interest. In our setting, we can back out the elasticity of earnings $z$ with respect ot the marginal tax rate by relating the response of the marginal buncher to the change in the marginal tax rates. If the kink size $\Delta t$ is small, then the non-parametric estimate of the (observed) elasticity of earnings is simply:

$$e = \frac{\Delta {z^*/z^*}}{\Delta t/(1-t)} $$

We can back this out from our estimate of the bunching mass $\hat{B}$ by observing that:

$$B = \int_{z^*}^{z^*+\Delta z^*} h_0(z)dz \approx h_0(z^*)\Delta z^*$$

Then, all we need to estimate the elasticity is an estimate of the bunching mass $\hat{B}$ and the height of the counterfactual density at the kink $\hat{h}_0(z^*)$, both of which are estimable. The elasticity estimate is then just:


$$e = \frac{\hat{B}/ \hat{h}_0(z^*) z^*}{\Delta t/(1-t)} $$


If however the kink is large, this approximation no longer holds. In this case, we an rely on some parametric assumptions on the utility function. The usual approach here is to specify a quasi-linear and iso-elastic function of the form:

$$ U(c,z;n) = c- \frac{n}{1+\frac{1}{e}}\Big(\frac{z}{n}\Big)^{1+\frac{1}{e}} $$

where $c = z - T(z)$. The optimal earnings supply function in this case is $z = n(1-\tau_1)^e$. Denoting by $n^*$ the ability level of the marginal buncher, then his optimal earnings are $z^*+ \Delta z^*  = n^*(1-\tau_0)^e$ under the linear schedule  and $z^*  = n^*(1-\tau_1)^e$ under the kinked schedule. Combining these gives:

$$e =\frac{ ln\Big(1+\frac{\Delta z^*}{z^*}\Big)}{ln\Big(\frac{1-\tau_{0}}{1-\tau_{1}}\Big)}$$

or using our estimable quantities:

$$e =\frac{ ln\Big(1+\frac{\hat{B}}{ \hat{h}_0(z^*)z^*}\Big)}{ln\Big(\frac{1-\tau_{0}}{1-\tau_{1}}\Big)}$$

## Theoretical foundations: notches

While a kink created a discrete change in the slope of the budget constraint, a notch creates a discrete change in its level. A typical example is a taxation system where above a given threshold $z^*$, the tax rate increases from $t_0$ to $t_1$ but applies to all income, not just that falling in the new bracket. In other words, instead of the marginal tax rate changing, the average tax rate changes. We analyse t his in the same way as with kinks, the only diference being that the tax function is now given by $T(z) = z(t_0 + (t_1-t_0) \mathbb{1}(z> z^*))$. The effect of this is shown in the following figures.


```{r, echo=FALSE,out.width="45%",  out.height="20%",fig.cap="Distributions Under Notched Tax Schedules",fig.show='hold',fig.align='center', fig.subcap=c('First','Second')}
knitr::include_graphics(c("jpegs/notch_budget.jpg","jpegs/notch_density.jpg"))
```

On the left, we see that a notch creates a drop in the budget constraint as an individual crosses $z^*$, essentially rotating the budget constraint through the origin. From our optimisation perspective, this agains leads to bunching from those with pre-notch earnings $z\in(z^*,z^*+\Delta z^*]$. The marginal buncher now is the individual tangent to both the linear tax schedule at $z^*+\Delta z^*$ and to the interior of the notched schedule at some lower level $z_I$, while at the same time being indifferent between $z_I$ and $z^*$.

Compared to the kink case, notches are more involved in two ways. First, they lead to a hole in the notched distribution between  $z^*$ and  $z_I$. While everyone with pre-notch earnings above the marginal buncher will also respond, by finding their tangency point along the notched schedule, this can only be above $z_I$ since that was the tangency point of the marginal buncher.

Furthermore, notches also create a dominated region $z\in(z^*,z^*+\Delta z_D]$ (market by the red dashed line) where no individual wants to locate. At any point in this range, consumption is lower and effort cost is higher than at $z^*$, placing individuals at lower indifference curves and making them strictly worse off.



### From Bunching at Notches to Elasticities

As with kinks, we can estimate both a reduced-form (assumption free) approximation, or rely on functional form assumptions on preferences. The reduced-form approximation is more involved than in the case of kinks, because we now need to convert the average tax to an implicit marginal tax rate that would have generated an equivalent bunching response. Denoting the marginal tax rate in this hypothetical scenario by $t^*$, and using the trapezoid rule, we get the following approximation:

$$ t^* \approx t + (2+ \Delta z^*/z^*) \frac{ z^* \Delta t}{\Delta z^*}$$

which results in the following reduced form elasticity:

$$ e = \frac{\Delta z^*/z^*}{\Delta t^* /(1-t^*)} \approx \frac{1}{2+\Delta z^*/z^*} \frac{(\Delta z^*/z^*)^2}{\Delta t/(1-t)}$$

For further details on this reduced-form approach, see Kleven's (2018) note.

The second approach is to employ a parametric functional form for utilities, and use the condition that the marginal buncher is indifferent between locating at $z^*$ and $z_I$ and equate the two utilities. This therefore necessitates a parametric assumption on the utility function. As before, we will assume the usual quasi-linear and iso-elastic form. This leads to the following utilities:

$$ U_{z^*} = (1-t_0)z^* - \frac{n^*}{1+\frac{1}{e}} \Bigg(\frac{z^*}{n^*} \Bigg)^{1+\frac{1}{e}}$$
$$ U_{z_I} = \Bigg(\frac{1}{1+e} \Bigg)  n^*(1-t_1)^{1+e}$$

Equating these and using the first-order condition $z = (1-t)^e$, we get the following condition:


$$ \frac{1}{1+\Delta z^*/z^*} - \frac{1}{1+1/e} \Bigg(\frac{1}{1+ \Delta z^*/z^*} \Bigg)^{1+1/e} - \frac{1}{1+e} \Bigg(1 - \frac{t_1-t_0}{1-t_0} \Bigg)^{1+e} = 0$$

# Note: to do
I don't do parametric stuff in notch, but do it in kinks? either do both versions or stick to one?


## other stuff
Bunching has causal inference at its core. The aim is to estimate how much of the bunching we observe at a particular level is caused by a change at that level. As with all cases of non-experimental causal inference, the challenge is to credibly estimate the counterfactual density at this level. The aim is to estimate what the counterfactual distribution $h_0(z)$ would have been in the absence of the kink at $z^*$, and compare this to the observed distribution in the presence of the kink. $\hat{B}$ is then the difference between the  empirical and counterfactual density. To proceed, I group individuals into earnings bins $j$ of width $\delta$, and fit a flexible polynomial to the empirical distribution.



The main methodology is based on the recently developed bunching estimator. The idea is to estimate what the counterfactual density would have been in the absence of the equal-earnings threshold, combine that with the empirical density to estimate the excess mass, and finally conduct hypothesis testing on whether the estimated excess mass is statistically significant.

To explain the main steps, I first introduce some notation: $\hat{B}$ stands for the estimated excess mass, $h_0(z)$ is what the counterfactual distribution  would have been in the absence of the reference point kink at $z^*$, and compare this to the observed distribution in the presence of the kink. $\hat{B}$ is then the difference between the  empirical and counterfactual density. To proceed, I group individuals into earnings bins $j$ of width $\delta$, and fit a flexible polynomial to the empirical distribution. Bunching can then be estimated by running the following regression:

## Empirical Application

### How the Bunching Mass is Estimated

To estimate bunching, we run the following specification on data that has already been groupped into bins:


$$c_j  = 
\sum_{i=0}^{p} \beta_i(z_j)^{i}+ \sum_{i=z_L}^{z_U} \gamma_i \mathbb{1}[z_j=i]+ \sum_{r \in R}
\rho_r  \mathbb{1} \Big[\frac{z_j}{r} \in \mathbb{N}\Big] + \sum_{k \in K} \theta_k  \mathbb{1}\Big[ z_j \in K \wedge z_j \notin [z_L,z_U] \Big] +v_j $$


where $c_j$ is the count of observations in bin $j$, $p$ is the order of polynomial, and $z_L$ and $z_U$ denote the lower and upper end of the bunching region. We allow for the bunching region to not be limited to just $z^*$ in order to allow for potentially diffuse bunching. We also allow for round number bunching, and for the presence of other bunch points in our bandwidth that are not associated with our $z^*$. Round number bunching is especially prevalent whenever dealing with earnings distributions. Not controlling for these will severely bias our estimate of the bunching mass.

Finally, to compare bunching across kinks or notches, we normalise by the average count in the bunching region.

We then get an estimate of the counterfactual density by using our fitted model to predict bin counts but excluding the contributions of the bunching region:

$$\hat{c}_j = \sum_{i=0}^{p} \hat{\beta_i}(z_j)^{i} + \sum_{r \in R}
\hat{\rho}_r  \mathbb{1} \Big[\frac{z_j}{r} \in \mathbb{N}\Big] + \sum_{k \in K} \hat{\theta}_k  \mathbb{1}\Big[ z_j \in K \wedge z_j \notin [z_L,z_U] \Big]$$


The estimate of the bunching mass is then the difference between the observed and (estimated) counterfactual mass in the bunching region:

$$\hat{B}^0 = \sum_{j=z_L}^{z_U}(c_j - \hat{c}_j)$$

This initial estimate is biased because it ignores that bunchers are moving downwards from counterfactual earnings above $z^*$. To correct for this, we shift upwards the counterfactual distribution lying to the right of $z^*$ until the count of observations under th empirical distribution equals that under the counterfactual distribution. This is usually referred to as the integration constraint correction. In practice, this is done by estimating the following specification by iteration, re-estimating $\hat{B}$ until a fixed point is found:


$$c_j \Bigg(1 + \mathbb{1}[j>z_U] \frac{\hat{B}^0}{\sum\limits_{j=z_U + 1}^{\infty} c_j}   \Bigg) = 
\sum_{i=0}^{p} \beta_i(z_j)^{i}+ \sum_{i=z_L}^{z_U} \gamma_i \mathbb{1}[z_j=i]+ \sum_{r \in R}
\rho_r  \mathbb{1} \Big[\frac{z_j}{r} \in \mathbb{N}\Big] + \sum_{k \in K} \theta_k  \mathbb{1}\Big[ z_j \in K \wedge z_j \notin [z_L,z_U] \Big] +v_j $$


It is usual to scale our final estimate of $\hat{B}$ by the average counterfactual frequency in the excluded range, $\hat{c}_0$, resulting in:

$$b=\frac{\hat{B}}{\hat{c}_0}$$

where $\hat{c}_0 = \Big[\frac{z_U - z_L}{\delta} \Big]^{-1}\sum_{j=z_L}^{z_U} \hat{\beta_i}(z_j)$. This allows comparison of bunching masses across different kinks and counterfactual levels.




### How is $z_U$ and $z_L$ set?
With kinks, both can be set visually as these will be obvious from a simple inspection of the density. With notches, visually determining $z_L$ is typically easy, but not so for $z_U$. In this case, it is possible to estimate this conjointly with the bunching through an iterative procedure relying on the intuition that the bunching mass must be equal to the missing mass. The approach then starts at $z^*$, shifting $z_U$ rightwards until this equality is reached.

### Examples

## Theoretical Foundations: Kinks
The estimator was developed within the context of taxpayers' responses to the location of changes in tax prices. While my explanation will also focus on this setting, it can be extended to any case where there are 
The main idea behind this estimator is simple.  if an otherwise smooth distribution exhibits bunching (a spike) at a given level, causal inference can be employed by estimating what the counterfactual density would have been, there what  



# References

Kleven, H (2018) "Calculating Reduced-Form Elasticities Using Notches", mimeo.
